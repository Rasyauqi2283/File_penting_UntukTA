<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login | BAPPENDA BPHTB</title>
  <link rel="icon" href="/asset/TitleE-bphtb.png" type="text/css">
  <link rel="stylesheet" href="design-n-script/design_css/asset_pelengkap.css" type="text/css">
  <link rel="stylesheet" href="design-n-script/design_css/login-design.css" type="text/css">
</head>
<body>
  <div class="login-container">
    <aside class="left-panel">
      <div class="logo-section">
        <img src="asset/Logo_image.svg" alt="Logo Bappenda" class="logo">
        <h3>BAPPENDA <br> KABUPATEN BOGOR</h3>
        <h1>E-BPHTB</h1>
        <p>"E-BPHTB: Layanan Pajak Modern"</p>
      </div>
      <div class="login-form">
        <form id="loginForm">
          <div class="input-group">
            <label for="identifier">UserID</label>
            <div class="input-wrapper">
              <input type="text" id="identifier" placeholder="UserID atau Username" required>
              <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                <circle cx="12" cy="7" r="4" />
              </svg>                        
            </div>
          </div>
          <div class="input-group">
            <label for="password">Kata Sandi</label>
            <div class="input-wrapper">
              <input type="password" id="password" placeholder="Kata Sandi" required>
              <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="5" y="11" width="14" height="10" rx="2" ry="2"></rect>
                <path d="M12 17v-2"></path>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>                        
            </div>
          </div>
          <a href="lupa-katasandi.html" class="forgot-password">Lupa Kata Sandi?</a>
                      <div id="message" class="message-box"></div>
          <button type="submit" class="login-button">MASUK</button>
          <p class="register">Belum Memiliki Akun? <a href="registrasi.html">Daftar Disini</a></p>
        </form>
      </div>
    </aside>

    <!-- Panel kanan dengan gambar latar dan informasi tambahan -->
    <div class="right-panel">
      <h2>SELAMAT DATANG DI E-BPHTB</h2>
      <p class="description">
        E-BPHTB adalah sistem elektronik yang digunakan untuk mengelola dan memproses Bea Perolehan Hak atas Tanah dan Bangunan (BPHTB). Sistem ini memungkinkan masyarakat untuk melakukan berbagai transaksi terkait BPHTB secara online, sehingga memudahkan proses pembayaran dan pelaporan.
      </p>
    </div>

    <div class="message" id="message"></div>
  </div>

<script>
        const loginForm = document.getElementById("loginForm");
        const messageDiv = document.getElementById("message");

        loginForm.addEventListener("submit", async function (e) {
            e.preventDefault();
            const identifier = document.getElementById("identifier").value;
            const password = document.getElementById("password").value;
            // Clear previous messages
            messageDiv.textContent = "";
            messageDiv.style.display = "none";
            messageDiv.className = "";
            try {
                const res = await fetch("http://localhost:3000/api/auth/login", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ identifier, password }),
                });

                const data = await res.json();

                // Tampilkan pesan
                messageDiv.style.display = "block";
                
                if (res.ok) {
                    // Tampilkan pesan sukses
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M12 2C6.5 2 2 6.5 2 12S6.5 22 12 22 22 17.5 22 12 17.5 2 12 2M10 17L5 12l1.4-1.4L10 14.2l7.6-7.6L19 8l-9 9z"/>
                            </svg>
                            <span>${data.message}</span>
                        </div>
                    `;
                    messageDiv.classList.add("success");

                    // Simpan data user di localStorage
                    localStorage.setItem("userid", data.userid);
                    localStorage.setItem("divisi", data.divisi);
                    localStorage.setItem("nama", data.nama);
                    localStorage.setItem("email", data.email);
                    localStorage.setItem("telepon", data.telepon);
                    localStorage.setItem("foto", data.foto);
                    localStorage.setItem("username", data.username);
                    localStorage.setItem("nip", data.nip || "");
                    localStorage.setItem("special_field", data.special_field || "");
                    localStorage.setItem("is_profile_complete", data.is_profile_complete);

                    // Redirect berdasarkan status profil dan divisi
                    setTimeout(() => {
                        if (!data.is_profile_complete) {
                            // Jika profil belum lengkap, arahkan ke halaman complete-profile
                            window.location.href = "profile-completetask.html";
                        } else {
                            // Jika profil sudah lengkap, arahkan ke dashboard sesuai divisi
                            redirectBasedOnDivision(data.divisi);
                        }
                    }, 1000);
                } else {
                    // Tampilkan pesan error
                    let errorMessage = data.message;
                    
                    // Custom message untuk error tertentu
                    if (res.status === 401) {
                        errorMessage = data.message.includes('Password') 
                            ? "Password yang dimasukkan salah" 
                            : "UserID/Username tidak terdaftar";
                    }

                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M13 13h-2V7h2m0 10h-2v-2h2M12 2a10 10 0 0 0-10 10a10 10 0 0 0 10 10a10 10 0 0 0 10-10a10 10 0 0 0-10-10z"/>
                            </svg>
                            <span>${errorMessage}</span>
                        </div>
                    `;
                    messageDiv.classList.add("error");
                }
            } catch (error) {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M13 13h-2V7h2m0 10h-2v-2h2M12 2a10 10 0 0 0-10 10a10 10 0 0 0 10 10a10 10 0 0 0 10-10a10 10 0 0 0-10-10z"/>
                        </svg>
                        <span>Gagal terhubung ke server. Coba lagi nanti.</span>
                    </div>
                `;
                messageDiv.classList.add("error");
                messageDiv.style.display = "block";
                console.error("Login error:", error);
            }
        });

        // Fungsi untuk redirect berdasarkan divisi
        function redirectBasedOnDivision(divisi) {
            switch (divisi) {
                case "Administrator":
                    window.location.href = "admin-dashboard.html";
                    break;
                case "Customer Service":
                    window.location.href = "cs-dashboard.html";
                    break;
                case "PPAT":
                case "PPATS":
                    window.location.href = "ppatk-dashboard.html";
                    break;
                case "LTB":
                    window.location.href = "ltb-dashboard.html";
                    break;
                case "LSB":
                    window.location.href = "lsb-dashboard.html";
                    break;
                case "Peneliti":
                    window.location.href = "peneliti-dashboard.html";
                    break;
                case "Peneliti Validasi":
                    window.location.href = "penelitiValidasi-dashboard.html";
                    break;
                case "BANK":
                    window.location.href = "bank-dashboard.html";
                    break;
                case "Wajib Pajak":
                    window.location.href = "wp-dashboard.html";
                    break;
                default:
                    window.location.href = "login.html"; // Jika divisi tidak dikenali
            }
        }
    </script>
</body>
</html>
